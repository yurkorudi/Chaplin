<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chaplin cinema | booking</title>
  <link rel="stylesheet" href="/static/css/globals.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body class="fade-in">
  <div class="home booking">
    <main class="main movie booking">
      <div class="left_menu">
        <div class="movie_logo">
          <img src="{{movie_info['img_src']}}" alt="">
        </div>
      </div>

      <div class="base_info">
        <div class="movie_name">
          <h1>{{movie_info['name']}}</h1>
        </div>
        <div class="movie_short_info">
          <p class="category">–õ–æ–∫–∞—Ü—ñ—è:</p>
          <p class="value_location">{{movie_info['location']}}</p>
          <p class="category">–î–∞—Ç–∞:</p>
          <p class="value_date"></p>
          <p class="category">–ß–∞—Å:</p>
          <p class="value_time"></p>
          <p class="category">–ú—ñ—Å—Ü–µ:</p>
          <p class="value_seat"></p>
          <p class="category">–†—è–¥:</p>
          <p class="value_row"></p>
          <p class="category">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:</p>
          <p class="value_duration">{{movie_info['duration']}} —Ö–≤</p>
          <p class="category">–í–∞—Ä—Ç—ñ—Å—Ç—å:</p>
          <p class="value_cost"></p>
        </div>

        <form action="{{ url_for('buy_ticket') }}" method="post">
          <div class="book_button">
            <button type="submit">–ü—Ä–∏–¥–±–∞—Ç–∏ –∫–≤–∏—Ç–æ–∫</button>
          </div>
        </form>

        <div class="seat-row">
          <div class="seat">
            <div class="monitor"><p>–ï–∫—Ä–∞–Ω</p></div>
            <div class="seats" id="seats"></div>
            <div class="tickets" id="tickets"></div>
          </div>
        </div>
        
      </div>

      <div class="right_menu">
        <h1>–†–æ–∑–∫–ª–∞–¥ –°–µ–∞–Ω—Å—ñ–≤</h1>
        <ul class="weekdays">
          <li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li>
        </ul>
        <ul class="schedule" id="schedule"></ul>
        <div id="session-buttons" class="session-buttons"></div>
      </div>
    </main>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const sessions = {{ movie_info['sessions'] | tojson }};
    console.log("üì¶ –°–µ—Å—ñ—ó –æ—Ç—Ä–∏–º–∞–Ω—ñ:", sessions);

    const sessionsByDay = {};
    sessions.forEach(s => {
      s._date = new Date(s.datetime);
      const d = s._date.getDate();
      if (!sessionsByDay[d]) sessionsByDay[d] = [];
      sessionsByDay[d].push(s);
    });

    const scheduleEl = document.getElementById('schedule');
    const sessionBtnsEl = document.getElementById('session-buttons');
    const seatsEl = document.getElementById('seats');

    const valDate = document.querySelector('.value_date');
    const valTime = document.querySelector('.value_time');
    const valSeat = document.querySelector('.value_seat');
    const valRow = document.querySelector('.value_row');
    const valCost = document.querySelector('.value_cost');

    let lastDayLi = null;
    let hallStructure = [];

    function drawHall() {
      seatsEl.innerHTML = '';
      if (!hallStructure || !hallStructure.length) {
        console.warn("‚ùó –ü–æ—Ä–æ–∂–Ω—è –∞–±–æ –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ª—É");
        return;
      }

      const rows = hallStructure.length;
      const cols = Math.max(...hallStructure.map(r => r.length));

      seatsEl.style.display = 'grid';
      seatsEl.style.gridTemplateColumns = `repeat(${cols},1fr)`;

      hallStructure.forEach((row, rIdx) => {
        row.forEach((cell, cIdx) => {
          const div = document.createElement('div');
          div.dataset.row = rIdx;
          div.dataset.col = cIdx;
          if (cell === 0) div.className = 'empty';
          else if (cell === 2) div.className = 'seat vip';
          else div.className = 'seat';
          seatsEl.appendChild(div);
        });
      });
    }

    function renderSessionButtons(day) {
      sessionBtnsEl.innerHTML = '';
      const arr = sessionsByDay[day] || [];

      if (!arr.length) {
        sessionBtnsEl.textContent = '–ù–µ–º–∞—î —Å–µ—Å—ñ–π –Ω–∞ —Ü–µ–π –¥–µ–Ω—å.';
        hallStructure = [];
        drawHall();
        return;
      }

      arr.forEach(s => {
        const hallName = s.hall?.name || s.hall_name || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
        const hallStruct = s.hall?.structure || s.hall_structure;

        const hh = s._date.getHours().toString().padStart(2, '0');
        const mm = s._date.getMinutes().toString().padStart(2, '0');

        const btn = document.createElement('button');
        btn.textContent = `${hh}:${mm} ‚Äî ${hallName}`;
        btn.addEventListener('click', () => {
          sessionBtnsEl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          valTime.textContent = `${hh}:${mm}`;
          hallStructure = hallStruct;
          console.log("üé≠ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ª—É:", hallStructure);
          drawHall();
        });

        sessionBtnsEl.appendChild(btn);
      });


      const firstBtn = sessionBtnsEl.querySelector('button');
      if (firstBtn) firstBtn.click();
    }

    function onDayClick(day, li) {
      if (lastDayLi) lastDayLi.classList.remove('active');
      li.classList.add('active');
      lastDayLi = li;
      valDate.textContent = day;
      valTime.textContent = '';
      valSeat.textContent = '';
      valRow.textContent = '';
      valCost.textContent = '';
      renderSessionButtons(day);
    }

    function renderCalendar() {
      scheduleEl.innerHTML = '';
      const today = new Date();
      const Y = today.getFullYear(), M = today.getMonth();
      const daysInMonth = new Date(Y, M + 1, 0).getDate();
      const firstDow = new Date(Y, M, 1).getDay();

      for (let i = 0; i < firstDow; i++) {
        const li = document.createElement('li');
        li.classList.add('empty');
        scheduleEl.appendChild(li);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const li = document.createElement('li');
        li.textContent = d;
        if (d === today.getDate()) li.classList.add('today');

        if (sessionsByDay[d]?.length) {
          const s0 = sessionsByDay[d][0]._date;
          const hh = s0.getHours().toString().padStart(2, '0');
          const mm = s0.getMinutes().toString().padStart(2, '0');
          li.innerHTML += ` <small>${hh}:${mm}</small>`;
        }

        li.addEventListener('click', () => onDayClick(d, li));
        scheduleEl.appendChild(li);
      }
    }

    renderCalendar();
    const todayLi = scheduleEl.querySelector('li.today');
    if (todayLi) todayLi.click();
  });
  </script>
</body>
</html>
