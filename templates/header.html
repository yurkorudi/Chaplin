<header class="header">
    <form action="{{ url_for('homepage')}}">
        <button class="invise" type="submit">
            <div class="logo">
                <div class="text-wrapper">Chaplin</div>
                <div class="div">cinema</div>
                <img class="blackhat" src="/static/img/hat.png" />
            </div>
        </button>
    </form>


    <div class="header-menu">
        <div class="topbtn-s">
            <form action="{{ url_for('market')}}">
                <div class="button-wrapper"><button class="button" type="submit">Магазин</button></div>
            </form>
            <form action="{{ url_for('homepage')}}">
                <div class="button-wrapper"><button class="button" type="submit">Головна</button></div>
            </form>
            <form action="{{ url_for('movies')}}">
                <div class="button-wrapper"><button class="button" type="submit">Фільми</button></div>
            </form>
            <form action="{{ url_for('about')}}">
                <div class="button-wrapper"><button class="button" type="submit">Про нас</button></div>
            </form>
            <div class="dropdown">
                <div class="button-wrapper">
                    <li><div class="button"><a>Ваше місто: <span id="selected-city">Виберіть місто</span></a></div>
                    <div class="dropdown-content">
                        <ul>
                            {% for c in cities %}                        
                            <li><button class="button city-btn" data-city='{{c}}'>{{c}}</button></li>
                            {% endfor %}
                        </ul>
                        
                    </div>
                </div>
            </div>
            <div class="button-wrapper user">
                <form action="{{ url_for('user')}}">
                    <div class="button"><button class="button" type="submit" id='profile', onclick='userclick()'>Профіль</button></div>
                </form>
                <div class="ico"></div>
            </div>
        </div>
    </div>


    <div class="burger-menu" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <nav class="mobile-menu">
        <ul>
            <li><a href="{{ url_for('homepage') }}" style="font-size: 26px;">головна</a></li>
            <li><a href="{{ url_for('market') }}">Магазин</a></li>
            <li><a href="{{ url_for('user') }}">профіль</a></li>
            <li><a href="{{ url_for('movies') }}">фільми</a></li>
            <li><a href="{{ url_for('about') }}">про нас</a></li>
            <li class="city-section">
                <div>Ваше місто: <span id="mobile-selected-city">Виберіть місто</span></div>
                <div class="city-buttons-mobile">
                    {% for c in cities %}
                    <button class="city-btn" data-city='{{c}}'>{{c}}</button>
                    {% endfor %}
                </div>
            </li>
        </ul>
    </nav>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const cityButtons = document.querySelectorAll(".city-btn");
            const selectedCitySpan = document.getElementById("selected-city");
            const mobileSelectedCitySpan = document.getElementById("mobile-selected-city");
            const profile = document.getElementById("profile");

            let savedCity = localStorage.getItem("selectedCity");

            console.log("Profile from session:", "{{ profile }}");
            if ("{{ profile }}") {
                profile.textContent = "{{ profile }}";
            }

            if (savedCity) {
                selectedCitySpan.textContent = savedCity;
                if (mobileSelectedCitySpan) {
                    mobileSelectedCitySpan.textContent = savedCity;
                }
                highlightSelectedCity(savedCity);
                
                fetch('/get_city')
                    .then(response => response.json())
                    .then(data => {
                        if (data.city !== savedCity) {
                            sendCityToServer(savedCity);
                        }
                    });
            }

            cityButtons.forEach(button => {
                button.addEventListener("click", function () {
                    let selectedCity = this.getAttribute("data-city");

                    if (selectedCity !== savedCity) {
                        localStorage.setItem("selectedCity", selectedCity);
                        selectedCitySpan.textContent = selectedCity;
                        if (mobileSelectedCitySpan) {
                            mobileSelectedCitySpan.textContent = selectedCity;
                        }
                        highlightSelectedCity(selectedCity);
                        sendCityToServer(selectedCity);
                    }
                });
            });

            function userclick(){
                url_for('user');
            }

            function sendCityToServer(city) {
                fetch('/set_city', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ city: city })
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    }
                });
            }
                
            function highlightSelectedCity(city) {
                cityButtons.forEach(button => {
                    if (button.getAttribute("data-city") === city) {
                        button.classList.add("active");
                    } else {
                        button.classList.remove("active");
                    }
                });
            }
        });     

        function toggleMenu() {
            const mobileMenu = document.querySelector('.mobile-menu');
            const burger = document.querySelector('.burger-menu');
            
            mobileMenu.classList.toggle('active');
            burger.classList.toggle('active');
            
            document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
        }


        document.querySelectorAll('.mobile-menu a').forEach(link => {
            link.addEventListener('click', () => {
                toggleMenu();
            });
        });


        document.querySelectorAll('.mobile-menu .city-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                let selectedCity = this.getAttribute('data-city');
                localStorage.setItem("selectedCity", selectedCity);
                
                document.getElementById('selected-city').textContent = selectedCity;
                document.getElementById('mobile-selected-city').textContent = selectedCity;
                
                toggleMenu();
            });
        });
    </script>
</header>